{% extends "main/layout.html" %}


{% block breadcrump %}
<span class="mx-5 text-orange-400 rotate-180">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
    </svg>
</span>

<a href="{% url 'main:employees' group.id %}" class="flex items-center text-orange-400 hover:bg-orange-400 hover:text-white rounded p-2 transition-all font-bold">
    <svg class="w-6 h-6 mx-2" stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 640 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
        <path d="M144 0a80 80 0 1 1 0 160A80 80 0 1 1 144 0zM512 0a80 80 0 1 1 0 160A80 80 0 1 1 512 0zM0 298.7C0 239.8 47.8 192 106.7 192h42.7c15.9 0 31 3.5 44.6 9.7c-1.3 7.2-1.9 14.7-1.9 22.3c0 38.2 16.8 72.5 43.3 96c-.2 0-.4 0-.7 0H21.3C9.6 320 0 310.4 0 298.7zM405.3 320c-.2 0-.4 0-.7 0c26.6-23.5 43.3-57.8 43.3-96c0-7.6-.7-15-1.9-22.3c13.6-6.3 28.7-9.7 44.6-9.7h42.7C592.2 192 640 239.8 640 298.7c0 11.8-9.6 21.3-21.3 21.3H405.3zM224 224a96 96 0 1 1 192 0 96 96 0 1 1 -192 0zM128 485.3C128 411.7 187.7 352 261.3 352H378.7C452.3 352 512 411.7 512 485.3c0 14.7-11.9 26.7-26.7 26.7H154.7c-14.7 0-26.7-11.9-26.7-26.7z"></path>
    </svg>

    <span class="mx-2">{{ group.title }}</span>
</a>
{% endblock %}



{% block body %}
<div x-data="{ modalOpen: false }">
    <button 
        @click="modalOpen = true"
        onclick="addEmployee()"
        class="bg-orange-400 flex items-center rounded py-3 px-5 font-semibold text-white hover:bg-opacity-75 transition-all"
    >
        إضافة موظف
        <span class="pr-2">
            <svg  class="fill-current font-bold" width="20" height="20" viewBox="0 0 24 24" focusable="false"><path d="M20 13h-7v7h-2v-7H4v-2h7V4h2v7h7v2z"></path></svg>
        </span>
    </button>
    <div class="flex h-screen flex-wrap items-center justify-center gap-5">
        {% for employee in employees %}
        <div class="flex gap-y-5 flex-col items-center justify-center p-10 rounded-lg shadow-md">
            <div class="overflow-hidden rounded-full w-28">
                <img class="w-full h-full object-cover object-center" src="{{ employee.main_img.image.url }}" alt="{{ employee.name }}">
            </div>
            <h1 class="text-xl mb-5 font-bold">
                {{ employee.name }}
            </h1>
    
            {% if not employee_last_year %}
            <button 
                @click="modalOpen = true"
                class="bg-orange-400 text-white py-3 px-8 rounded text-sm font-semibold hover:bg-opacity-75 transition-all"
                onclick="addYear({{ employee.id }})"
            >
                إضافة سنة
            </button>
            {% endif %}
            
            {% if employee_last_year %}
                {% if not employee_last_month %}
                <button 
                    @click="modalOpen = true"
                    class="bg-orange-400 text-white py-3 px-8 rounded text-sm font-semibold hover:bg-opacity-75 transition-all"
                    onclick="addMonth({{ employee.id }}, {{ employee_last_year.id }})"
                >
                    إضافة شهر
                </button>
                {% endif %}
            {% endif %}
    
            {% if employee_last_month %}
            <a href="{% url 'main:profile' group.id employee.id employee_last_year.id employee_last_month.id %}">
                <button class="bg-orange-400 text-white py-3 px-8 rounded text-sm font-semibold hover:bg-opacity-75 transition-all">عرض التفاصيل</button>
            </a>
            {% endif %}
        </div>
        {% empty %}
        لا توجد بيانات.
        {% endfor %}
    
    
        <!-- Modal -->
        {% include "main/components/Modal.html" %}

    </div>
</div>

<script>
    const modal = document.getElementById("modal")
    const imagesModal = document.getElementById("imagesModal")
    let skip = 0

    function addYear(employeeId){
        modal.innerHTML = 
        `<h3 class="pb-2 mb-3 text-xl font-bold text-dark sm:text-2xl">
            إضافة سنة
        </h3>

        <form action={% url 'main:addYear' group.id %} method="POST">
            {% csrf_token %}
            <input
                class="w-full max-w-xl px-4 py-2 border rounded-md dark:bg-darker dark:border-gray-700 focus:outline-none focus:ring focus:ring-primary-100 dark:focus:ring-primary-darker" 
                type="text" 
                placeholder="عنوان السنة، 2023 مثلاً" 
                required=""
                x-ref="input"
                name="title"
            >
            <input class="hidden" name="employee" value="${employeeId}" hidden>
            <input class="hidden" name="more_hours" value="0" hidden>
            <input class="hidden" name="more_minutes" value="0" hidden>
            <input class="hidden" name="less_hours" value="0" hidden>
            <input class="hidden" name="less_minutes" value="0" hidden>

            <div class="flex flex-wrap justify-center mt-5 -mx-3">
                <div class="w-1/6 px-3">
                    <button
                        @click="modalOpen = false"
                        class="block w-full p-3 text-base font-bold text-center text-white transition bg-red-600 border rounded-lg"
                    >
                        إلغاء
                    </button>
                </div>
                <div class="w-1/6 px-3">
                    <button
                        type="submit"
                        class="block w-full p-3 text-base font-bold text-center transition border rounded-lg bg-primary border-primary hover:bg-opacity-90"
                    >
                        تم
                    </button>
                </div>
            </div>
        </form>`
    }

    function addMonth(employeeId, yearId){
        modal.innerHTML = 
        `<h3 class="pb-2 mb-3 text-xl font-bold text-dark sm:text-2xl">
            إضافة شهر
        </h3>

        <form action={% url 'main:initMonth' group.id %} method="POST">
            {% csrf_token %}
            <input
                class="w-full max-w-xl px-4 py-2 border rounded-md dark:bg-darker dark:border-gray-700 focus:outline-none focus:ring focus:ring-primary-100 dark:focus:ring-primary-darker" 
                type="text" 
                placeholder="عنوان الشهر، أكتوبر مثلاً" 
                required=""
                x-ref="input"
                name="title"
            >
            <input class="hidden" name="employee" value="${employeeId}" hidden>
            <input class="hidden" name="year" value="${yearId}" hidden>
            <input class="hidden" name="more_hours" value="0" hidden>
            <input class="hidden" name="more_minutes" value="0" hidden>
            <input class="hidden" name="less_hours" value="0" hidden>
            <input class="hidden" name="less_minutes" value="0" hidden>

            <div class="flex flex-wrap justify-center mt-5 -mx-3">
                <div class="w-1/6 px-3">
                    <button
                        @click="modalOpen = false"
                        class="block w-full p-3 text-base font-bold text-center text-white transition bg-red-600 border rounded-lg"
                    >
                        إلغاء
                    </button>
                </div>
                <div class="w-1/6 px-3">
                    <button
                        type="submit"
                        class="block w-full p-3 text-base font-bold text-center transition border rounded-lg bg-primary border-primary hover:bg-opacity-90"
                    >
                        تم
                    </button>
                </div>
            </div>
        </form>`
    }

    function addEmployee(){
        modal.innerHTML = 
        `<h3 class="pb-2 mb-3 text-xl font-bold text-dark sm:text-2xl">
            إضافة موظف
        </h3>

        <form class="flex flex-col justify-center gap-y-3" action={% url 'main:addEmployee' group.id %} method="POST">
            {% csrf_token %}
            

            <div class="flex justify-center items-center gap-x-3">
                <input
                    class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring" 
                    type="text" 
                    placeholder="اسم الموظف" 
                    required=""
                    x-ref="input"
                    name="name"
                >
                <input
                    class="w-1/5 px-4 py-2 border rounded-md focus:outline-none focus:ring" 
                    type="number" 
                    placeholder="التسلسل" 
                    required=""
                    name="order"
                    value=""
                >
            </div>
            <div class="flex justify-start items-center">
                <p 
                    onclick="fetchAndInsertImages()"
                    class="bg-orange-400 flex cursor-pointer select-none items-center rounded py-3 px-5 font-semibold text-white hover:bg-opacity-75 transition-all"
                >
                    إضافة صورة
                    <span class="pr-2">
                        <svg  class="fill-current font-bold" width="20" height="20" viewBox="0 0 24 24" focusable="false"><path d="M20 13h-7v7h-2v-7H4v-2h7V4h2v7h7v2z"></path></svg>
                    </span>
                </p>    
            </div>

            <div id="imagesContainer" class="flex mx-auto flex-wrap max-w-[40rem] items-start justify-center gap-4 py-2"></div>

            <div class="mt-4 flex justify-center">
                <p
                    id="loadMore"
                    onclick="loadMoreImages()"
                    class="hidden cursor-pointer px-4 py-2 mx-auto text-base text-center text-white bg-gray-900 rounded-lg hover:bg-opacity-90 focus:outline-none focus:shadow-outline"
                >
                    تحميل المزيد
                </p>
            </div>

            <input class="hidden" name="main_img" id="main_img" value="1" hidden>
            <input class="hidden" name="group" value="{{ group.id }}" hidden>

            <div class="flex flex-wrap justify-center mt-3 -mx-3">
                <div class="w-1/6 px-3">
                    <button
                        @click="modalOpen = false"
                        class="block w-full p-3 text-base font-bold text-center text-white transition bg-red-600 border rounded-lg"
                    >
                        إلغاء
                    </button>
                </div>
                <div class="w-1/6 px-3">
                    <button
                        type="submit"
                        class="block w-full p-3 text-base font-bold text-center transition border rounded-lg hover:bg-opacity-90"
                    >
                        تم
                    </button>
                </div>
            </div>
        </form>`
    }


    async function fetchAndInsertImages(){
        document.getElementById("loadMore").classList.remove("hidden")
        let url = `{% url 'main:images' %}?skip=${skip}`
        let options = {
            method: "GET",
            headers: {
                "X-Requested-With": "XMLHttpRequest",
            }
        }

        try {
            const response = await fetch(url, options)
            imagesData = await response.json()

            imagesData.context.forEach(image => {
                document.getElementById("imagesContainer").innerHTML += 
                `<div class="flex flex-col gap-y-2 w-36">
                    <div 
                        class="h-24 overflow-hidden transition-all border rounded-md cursor-pointer image hover:scale-110 w-36"
                        onclick="selectImage(this);document.getElementById('logo').value = this.querySelector('img').alt"
                    >
                        <img class="object-cover object-center w-full h-full" src="{{ media_path }}${image.image}" alt="${image.id}">
                    </div>
                    <p class="line-clamp-2">${image.title}</p>
                </div>`
            })
        } catch (error) {
            console.error("Error fetching images:", error)
        }
    }

    function loadMoreImages() {
        skip += 5
        fetchAndInsertImages()
    }

    function selectImage(image){
        const images = document.querySelectorAll(".image")
        images.forEach(item => item.classList.remove("border-red-500", "scale-110", "border-2"))
        image.classList.add("border-red-500", "scale-110", "border-2")
    }
</script>
{% endblock %}